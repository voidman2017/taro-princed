# 页面page对应运行时

**以page/index/index 为例，运行时的 js：**

```javascript
var inst = Page((0,_tarojs_runtime__WEBPACK_IMPORTED_MODULE_0__.createPageConfig)(_packages_taro_loader_lib_raw_js_index_vue__WEBPACK_IMPORTED_MODULE_1__["default"], 'pages/index/index', {root:{cn:[]}}, config || {}))
```

![1690269177206](image/运行时/1690269177206.png)

我们简化一下：

![1690269694239](image/运行时/1690269694239.png)

**其中**

* `_tarojs_runtime__WEBPACK_IMPORTED_MODULE_0__.createPageConfig` 即 taro/runtime 中  `createPageConfig`

**接受参数：**

* **component:** `_packages_taro_loader_lib_raw_js_index_vue__WEBPACK_IMPORTED_MODULE_1__['default']`

![1690276792721](image/运行时/1690276792721.png)

* **pageName：`'pages/index/index'`**
* **data：** `{root:{cn:[]}}`
* **pageConfig:	**`{}`

`createPageConfig` 方法定义在 packages/taro-runtime/src/dsl/common.ts

![1690276986850](image/运行时/1690276986850.png)

**通过createPageConfig生成config，最终调用 Page 构造器生成页面**：

![1690277038545](image/运行时/1690277038545.png)

**页面代码如下：**

```vue
<template>
  <view class="index">
    <text>{{ msg }}</text>
    <button @tap="clickHandler"> click </button>
  </view>
</template>

<script>
import './index.scss'

export default {
  data () {
    return {
      msg: 'Hello world!'
    }
  },
  methods:{
    clickHandler(){
      this.msg += '!'
    }
  }
}
</script>
```

**修改生成的 index.wxml**

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1645705208713-d99983d6-1d82-4115-ad1a-739fc4657b21.png)

**可以看到：**

![1690277179520](image/运行时/1690277179520.png)

**即渲染的核心就是通过root定义内容结合模板进行渲染**

**那么问题是** : root是如何生成的？？？？？？

**目前初步看是 packages/taro-runtime/src/dom/root.ts 进行root设置的 ；（开发模式下可以将 packages/taro-runtime/src/options.ts 中 debug 开启，查看设置的root值）**

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1645707584750-6b98e4ec-ab71-4a96-a653-ff2a5e93c537.png)

`normalUpdate`：

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1645707625215-e7b999f0-2303-4c89-982b-a057afa93ed4.png)

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648633508729-a8d203ea-3d27-4f49-a359-39ad8f5998ce.png)

**data['root.cn[0]'] 是调用 ['root.cn.[0]', 'root.cn[0]'] 对应的函数生成的。**

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648696380105-6e56d4c3-001d-4c77-9062-8e4d1df8cb1e.png)

* **data：**

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648696496942-6b660877-884a-4ce0-abfc-a70d96dcce6e.png)

* **resetPaths：**

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648696405497-0652d886-e6b3-4759-8a8d-69e7a9a1924a.png)![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648696523661-4144416e-4f29-4991-8e78-adbfd741b5e8.png)

* **【112-115】将 root.cn.[0] 转换成对应的 fn 执行的结果**

# ['root.cn.[0]', 'root.cn[0]'] 对应的函数挂载：

**packages/taro-runtime/src/dom/node.ts**

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648696682862-fc9e33a3-6648-4c09-bda7-25ee1abf7045.png)

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648696779857-109fcae7-4813-40c1-90ca-b84a0f92d624.png)

**packages/taro-mini-runner/src/webpack/build.conf.ts**

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648714564815-8f0b8564-673f-4848-bef0-dd75ff3d16de.png)

**可以看到这里有使用 plugin.provierPlugin 定义了 document、window、Element。**

**造成的结果，当基于 vue 实现 vnode => dom的过程中调用 document.createElement 之类的api时，实际执行的是 taro中定义的运行时的document的api。**

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648720234341-5516b36a-1ea9-4987-8e2c-454cd932c6a9.png)

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648720249491-18081529-538f-4b39-8f8b-7dda5e6bd327.png)

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648720769832-f5a11a06-022e-4426-a2cc-c3cd45d6355e.png)

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648719678980-8bd73a04-7e86-41c1-8dee-d6d8f850b6c2.png)

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648719709636-6bbb2fe6-58e9-4c14-a0dd-bed1dfc0e4d2.png)

![](https://cdn.nlark.com/yuque/0/2022/jpeg/233312/1648869422216-13aebd7d-b5c0-4485-a34d-a9f578a820b8.jpeg)

# wx["webpackJsonp"]

**wx["webpackJsonp"] 是 taro 挂载在 wx 上的新增属性。**

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648547673310-d6430a55-d8ef-489a-b584-c900b5a7d350.png)

![](https://cdn.nlark.com/yuque/0/2022/png/233312/1648547550495-7bc1679e-40c8-4e1b-acdb-42f894d76947.png)

**可以看到 webpackJsonp 是一个二维数组。数组每一个项都是一个数组。以 app.js 为例：**

**第一个参数： 数组 ['app']**

**第二个参数：对象 **

**第三个参数：数组 [["./src/app.ts","runtime","vendors","common"]]**
